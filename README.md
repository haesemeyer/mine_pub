# Model identification of neural encoding (MINE)

Repository for the code used in developing, testing and using MINE.
The paper "Model discovery to link neural activity to behavioral tasks" which publishes this code can be found at:

[Costabile JD, Balakrishnan KA, Schwinn S, Haesemeyer M (2023) eLife 12:e83289](https://doi.org/10.7554/eLife.83289
)



## Main code modules
### mine.py
Simple to use interface to apply MINE to data as described in the last paper figure
and below.
### model.py
Includes the class definition of the CNN that forms the core of MINE.
### taylorDecomp.py
Contains routines for Taylor decomposition and associated metrics.
### rwave_data_fit.py and rwave_decompose.py
Analysis scripts for the zebrafish random wave data demonstrating using MINE outside the _mine.py_ interface.
### utilities.py
Contains general helper functions for data management, clustering, etc.

## Notes

### Interface to MINE
The ```Mine``` class in _mine.py_ is the main interface to MINE.
Data is returned in a ```MineData``` object defined in _mine.py_ as well.
An example for running MINE is given in _processMusall.py_ as well as below:

```python
import numpy as np
from typing import List
from mine import Mine
import h5py
predictors: List[np.ndarray]  # list of m_timepoints long vectors of predictors
for p in predictors:
    # z-score all predictors
    p -= np.mean(p)
    p /= np.std(p)
responses: np.ndarray  # n_responses * m_timepoints matrix of responses to fit
# z-score responses
responses -= np.mean(responses)
responses /= np.std(responses)
# Create Mine object with the following options:
# Use 2/3 of the timepoints for traning last third for testing
# Use 50 timepoints as model history - NOTE: Shifting predictors relative to responses
#       allows to capture preparatory activity as well see processMusall.py
# Consider any neuron with a test correlation >= 0.5 as fit by MINE
#       only for these neurons will metrics be computed
# Compute Taylor metrics including complexity/nonlinearity evaluation
# Return receptive fields (network jacobians). To perform exhaustive receptive field
#       analysis as in cnn_sta_test.py, set miner.return_hessians to True and extract
#       principal dynamic modes from joint matrix created from Jacobians and Hessians
#       (see cnn_sta_test.py and paper Methods section for details)
# To calculate Taylor metrics predict 25 frames ahead
# Compute metrics every five frames
miner = Mine(2.0/3, 50, 0.5, True, True, 25, 5)
# create file to store fit model weights during analysis
with h5py.File("model_data.hdf5", "w") as model_file:
    miner.model_weight_store = model_file
    # analyze data with this MINE object, returning MineData object - since  miner.model_weight_store was set
    # whenever a model is fit and passes threshold its weights will be stored in a group
    # with the name cell_{index}_weights
    mine_data = miner.analyze_data(predictors, responses)
# save mine_data to hdf5 file
with h5py.File("result.hdf5", 'w') as dfile:
    mine_data.save_to_hdf5(dfile)
```

### Figure panel arrangements
Panels for test figures of MINE were generated using _cnn_fit_test.py_, _cnn_sta_test.py_, _mine_edf.py_ and
_cnn_nonlin_test.py_. Panels for the figure on mouse cortical data were generated
using _plotMusall.py_. Panels for zebrafish figures were generated using
_rwave_plot_panels.py_ and _rspinal_plot_panels.py_.

## Dependencies
All required dependencies are listed in environment_utf8.yml

## Associated data
Raw acquisition data in NWB format is deposited on [DANDI](https://dandiarchive.org) in the following DANDIsets:
- [Forebrain data](https://dandiarchive.org/dandiset/000235/0.230316.1600)
- [Midbrain data](https://dandiarchive.org/dandiset/000236/0.230316.2031)
- [Hindbrain data](https://dandiarchive.org/dandiset/000237/0.230316.1655)
- [Reticulospinal data](https://dandiarchive.org/dandiset/000238/0.230316.1519)

Final project data (generated by running _rwave_build_main.py_, _rspinal_build_main.py_, and _processMusall.py_
) are deposited on zenodo.org:

[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.7737788.svg)](https://doi.org/10.5281/zenodo.7737788)

Fit model weight data for the zebrafish and mouse cortex dataset are deposited on zenodo.org split across
the folllowing two repositories. These weights were generated by running _rwave_data_fit.py_ and _processMusall.py_
respectively:

[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.7738603.svg)](https://doi.org/10.5281/zenodo.7738603)
[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.7741542.svg)](https://doi.org/10.5281/zenodo.7741542)



---
All code is licensed under the MIT license. See LICENSE for details.  
&copy; Martin Haesemeyer, Kaarthik A Balakrishnan and Jamie D Costabile, 2020-2023